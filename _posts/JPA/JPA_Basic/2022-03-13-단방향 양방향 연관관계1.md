---
title: 단방향 양방향 연관관계
date : 2022-03-13
categories : [JPA, JPA_Basic]
tags: [JPA]
---
## 단방향 연관관계
테이블은 id 로 조인해오지만(방향성이 없음)
* 외래키 하나로 양쪽 조인 가능
* 객체는 참조값으로 가져옴
  * 참조용 필드가 있는 쪽으로만 참조 가능

여기서 둘  사이의 갭이 생김

## 양방향 연관관계
**연관관계의 주인이 있어야하는 이유:**<br>
테이블은 fk 설정으로 어느쪽 테이블에서 조인해서도 반대쪽 값 가져올수 있음(주인이 필요없음)
* 객체는 다름 참조값이 있는쪽에서만 접근가능
* 양쪽에 조회가능하게 만들어 놓으면 ()
  * 문제점 : 회원의 팀 정보 변경하려 할때 (Member객체의 TEAM_ID FK 변경)<br>
    * (Member, Team) Member 객체에 있는 team 을 바꾸는지 Team객체 있는 members(List)의 값을 바꾸는지
  * 둘의 값이 다를때 어느쪽을 믿고 변경할까?기준은?

그래서 중요한게 연관관계의 주인을 정해야함
* 주인인 쪽이 변경되야 등록 수정 가능 - 외래키가 있는쪽으로(다대일에서 다쪽)
* 주인 아닌쪽은 읽기만 가능(mappedBy 적힌쪽)

외래키가 있는 쪽이 주인으로 설정
* 아니게 되면 TEAM 테이블 바꿧는데 MEMBER 테이블에 update, insert 쿼리 나가는게 헷갈려
* 그리고 fk 있는 쪽에 있으면 쿼리 바로 넣을때도 성능이 좋음
* ManyToOne인 쪽의 many

### 양방향 관계 사용 주의점
* 그래도 양방향 연관관계에 있는 주인, mappedBy 둘다 setter로 값 넣어줘
  * 안그런경우 mappedBy 쪽이 영속성컨택스트(1차 캐시)에 있는데 그럼 참조하려는 객체 값이 현재 없음
    (mappedBy객체에서 연관관계 주인쪽 조회하려 할때 em.flush, em.clear 하면 jpa에서 members가져오는 쿼리 날려서 되긴함)

* 테스트케이스 작성할때 jpa 의존적이지 않게 작성하는게 좋으니
* jpa는 객체에 setter함수 기준으로 보니 하나쪽에 저장하면 양쪽 다 저장되게 하는 연관관계편의함수 작성하면 좋음(다쪽이든 1쪽이든 상황에 따라)
* 양방향 매핑 무한 루프 조심(lombok-toString, JSON생성 라이브러리)
  * 객체 둘다 toString 생성하면 member 객체에서 toString 호출시 team객체의 toString 호출 (여기의 toString내용에 members 출력하는게 있다면 또 member toString 호출) - 무한루프
  * controller에서 엔티티반환할때 json생성 라이브러리 호출하면서 무한루프 걸릴수있음 - controller에서 엔티티 그대로 반환금지
    * 다른 이유- 엔티티를 변경하면 엔티티 스펙이 바뀌는 거
    * dto로 변환해서 반환

### 정리
단방형관계만으로도 이미 연관관계 매핑 완료(테이블 설계 관점에서)<br>
양방향 관계는 반대방향으로 조회 기능이 추가된것 뿐(테이블에 영향 주지않음 필요할때 추가)

*** 
_출처 : 인프런 강의 <br>_
*자바ORM 표준 JPA 프로그래밍 - 기본편 [김영한]*